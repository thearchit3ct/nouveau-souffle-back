// Nouveau Souffle - Prisma Schema
// Stack: PostgreSQL 16, Prisma 7, NestJS 11
// Auth: SuperTokens (passkey + email/pwd + 2FA TOTP)

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
  DELETED
}

enum Civility {
  M
  MME
  AUTRE
}

enum DonationType {
  ONE_TIME
  RECURRING
}

enum DonationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELED
}

enum PaymentMethod {
  CARD
  SEPA
  APPLE_PAY
  GOOGLE_PAY
}

enum ReceiptStatus {
  GENERATED
  SENT
  DOWNLOADED
  CANCELED
}

enum RecurrenceFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum RecurrenceStatus {
  ACTIVE
  PAUSED
  CANCELED
  EXPIRED
}

enum MembershipStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELED
  REJECTED
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EventType {
  CONFERENCE
  FORMATION
  COLLECTE
  AG
  SOCIAL
  WORKSHOP
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ONGOING
  COMPLETED
  CANCELED
}

enum EventVisibility {
  PUBLIC
  MEMBERS
  PRIVATE
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELED
  WAITLISTED
}

enum UserRole {
  ANONYMOUS
  DONOR
  MEMBER
  VOLUNTEER
  COORDINATOR
  ADMIN
  SUPER_ADMIN
}

// ---------------------------------------------------------------------------
// Models
// ---------------------------------------------------------------------------

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  supertokensId     String?   @unique @map("supertokens_id")
  firstName         String    @map("first_name")
  lastName          String    @map("last_name")
  phone             String?
  civility          Civility?
  birthDate         DateTime? @map("birth_date")
  avatarUrl         String?   @map("avatar_url")
  emailVerified     Boolean   @default(false) @map("email_verified")
  isActive          Boolean   @default(true) @map("is_active")
  status            UserStatus @default(PENDING)
  role              UserRole   @default(DONOR)
  preferences       Json      @default("{}")
  addressLine1      String?   @map("address_line_1")
  addressLine2      String?   @map("address_line_2")
  postalCode        String?   @map("postal_code")
  city              String?
  country           String    @default("FR")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  donations          Donation[]
  memberships        Membership[]        @relation("MembershipUser")
  secondaryMemberships Membership[]      @relation("MembershipSecondaryUser")
  approvedMemberships  Membership[]      @relation("MembershipApprover")
  articles           Article[]
  eventsCreated      Event[]
  eventRegistrations EventRegistration[]
  notifications      Notification[]
  auditLogs          AuditLog[]
  sessions           UserSession[]
  donationRecurrences DonationRecurrence[]

  @@index([status])
  @@index([role])
  @@index([email])
  @@map("users")
}

model Organization {
  id           String   @id @default(uuid())
  name         String
  siren        String?
  type         String   @default("company")
  addressLine1 String?  @map("address_line_1")
  addressLine2 String?  @map("address_line_2")
  postalCode   String?  @map("postal_code")
  city         String?
  country      String   @default("FR")
  phone        String?
  email        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  donations Donation[]

  @@map("organizations")
}

model MembershipType {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  description    String?
  price          Decimal  @db.Decimal(10, 2)
  durationMonths Int      @default(12) @map("duration_months")
  maxUsers       Int      @default(1) @map("max_users")
  benefits       Json     @default("[]")
  isActive       Boolean  @default(true) @map("is_active")
  displayOrder   Int      @default(0) @map("display_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  memberships Membership[]

  @@map("membership_types")
}

model Membership {
  id                  String           @id @default(uuid())
  userId              String           @map("user_id")
  membershipTypeId    String           @map("membership_type_id")
  secondaryUserId     String?          @map("secondary_user_id")
  status              MembershipStatus @default(PENDING)
  amountPaid          Decimal          @db.Decimal(10, 2) @map("amount_paid")
  stripeSubscriptionId String?         @map("stripe_subscription_id")
  startDate           DateTime         @map("start_date")
  endDate             DateTime         @map("end_date")
  memberNumber        String?          @unique @map("member_number")
  autoRenew           Boolean          @default(false) @map("auto_renew")
  approvedAt          DateTime?        @map("approved_at")
  approvedById        String?          @map("approved_by_id")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  user           User           @relation("MembershipUser", fields: [userId], references: [id], onDelete: Cascade)
  membershipType MembershipType @relation(fields: [membershipTypeId], references: [id], onDelete: Restrict)
  secondaryUser  User?          @relation("MembershipSecondaryUser", fields: [secondaryUserId], references: [id], onDelete: SetNull)
  approvedBy     User?          @relation("MembershipApprover", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([membershipTypeId])
  @@map("memberships")
}

model Donation {
  id                    String          @id @default(uuid())
  userId                String?         @map("user_id")
  organizationId        String?         @map("organization_id")
  projectId             String?         @map("project_id")
  recurrenceId          String?         @map("recurrence_id")
  amount                Decimal         @db.Decimal(12, 2)
  currency              String          @default("EUR")
  type                  DonationType
  status                DonationStatus  @default(PENDING)
  paymentMethod         PaymentMethod?  @map("payment_method")
  stripePaymentIntentId String?         @map("stripe_payment_intent_id")
  stripeChargeId        String?         @map("stripe_charge_id")
  isAnonymous           Boolean         @default(false) @map("is_anonymous")
  receiptRequested      Boolean         @default(true) @map("receipt_requested")
  receiptNumber         String?         @map("receipt_number")
  metadata              Json            @default("{}")
  paidAt                DateTime?       @map("paid_at")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")

  user         User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization?       @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  project      Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  recurrence   DonationRecurrence? @relation(fields: [recurrenceId], references: [id], onDelete: SetNull)
  receipts     DonationReceipt[]

  @@index([userId, status, paidAt])
  @@index([projectId])
  @@index([organizationId])
  @@map("donations")
}

model DonationReceipt {
  id            String        @id @default(uuid())
  donationId    String        @map("donation_id")
  receiptNumber String        @unique @map("receipt_number")
  fiscalYear    Int           @map("fiscal_year")
  amount        Decimal       @db.Decimal(12, 2)
  filePath      String        @map("file_path")
  status        ReceiptStatus @default(GENERATED)
  generatedAt   DateTime      @default(now()) @map("generated_at")
  sentAt        DateTime?     @map("sent_at")
  createdAt     DateTime      @default(now()) @map("created_at")

  donation Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)

  @@index([donationId])
  @@index([fiscalYear])
  @@map("donation_receipts")
}

model DonationRecurrence {
  id                  String              @id @default(uuid())
  userId              String              @map("user_id")
  projectId           String?             @map("project_id")
  amount              Decimal             @db.Decimal(12, 2)
  frequency           RecurrenceFrequency @default(MONTHLY)
  status              RecurrenceStatus    @default(ACTIVE)
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  stripeCustomerId    String?             @map("stripe_customer_id")
  nextPaymentDate     DateTime?           @map("next_payment_date")
  lastPaymentDate     DateTime?           @map("last_payment_date")
  paymentCount        Int                 @default(0) @map("payment_count")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  canceledAt          DateTime?           @map("canceled_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  donations Donation[]

  @@index([userId, status])
  @@index([status, nextPaymentDate])
  @@map("donation_recurrences")
}

model Project {
  id              String        @id @default(uuid())
  name            String
  slug            String        @unique
  description     String?
  targetAmount    Decimal?      @db.Decimal(12, 2) @map("target_amount")
  collectedAmount Decimal       @default(0) @db.Decimal(12, 2) @map("collected_amount")
  status          ProjectStatus @default(DRAFT)
  startDate       DateTime?     @map("start_date")
  endDate         DateTime?     @map("end_date")
  imageUrl        String?       @map("image_url")
  isFeatured      Boolean       @default(false) @map("is_featured")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  donations   Donation[]
  recurrences DonationRecurrence[]

  @@index([status])
  @@index([slug])
  @@map("projects")
}

model Article {
  id               String        @id @default(uuid())
  authorId         String        @map("author_id")
  title            String
  slug             String        @unique
  excerpt          String?
  content          String
  featuredImageUrl String?       @map("featured_image_url")
  status           ArticleStatus @default(DRAFT)
  seoMetadata      Json          @default("{}") @map("seo_metadata")
  viewCount        Int           @default(0) @map("view_count")
  commentsEnabled  Boolean       @default(false) @map("comments_enabled")
  publishedAt      DateTime?     @map("published_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  author     User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories ArticleCategory[]

  @@index([authorId])
  @@index([status, publishedAt])
  @@index([slug])
  @@map("articles")
}

model Category {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  description  String?
  color        String?
  parentId     String?  @map("parent_id")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  parent   Category?         @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[]        @relation("CategoryHierarchy")
  articles ArticleCategory[]

  @@index([slug])
  @@map("categories")
}

model ArticleCategory {
  id         String   @id @default(uuid())
  articleId  String   @map("article_id")
  categoryId String   @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  article  Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([articleId, categoryId])
  @@map("article_categories")
}

model Event {
  id                 String          @id @default(uuid())
  createdById        String          @map("created_by_id")
  title              String
  slug               String          @unique
  description        String?
  type               EventType       @default(OTHER)
  status             EventStatus     @default(DRAFT)
  visibility         EventVisibility @default(PUBLIC)
  startDatetime      DateTime        @map("start_datetime")
  endDatetime        DateTime?       @map("end_datetime")
  locationName       String?         @map("location_name")
  locationAddress    String?         @map("location_address")
  latitude           Decimal?        @db.Decimal(10, 7)
  longitude          Decimal?        @db.Decimal(10, 7)
  capacity           Int?
  registrationsCount Int             @default(0) @map("registrations_count")
  price              Decimal         @default(0) @db.Decimal(10, 2)
  isFree             Boolean         @default(true) @map("is_free")
  imageUrl           String?         @map("image_url")
  program            String?
  customFields       Json            @default("[]") @map("custom_fields")
  publishedAt        DateTime?       @map("published_at")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  createdBy     User                @relation(fields: [createdById], references: [id], onDelete: Cascade)
  registrations EventRegistration[]

  @@index([status, startDatetime])
  @@index([slug])
  @@map("events")
}

model EventRegistration {
  id                    String             @id @default(uuid())
  eventId               String             @map("event_id")
  userId                String?            @map("user_id")
  status                RegistrationStatus @default(CONFIRMED)
  participantCount      Int                @default(1) @map("participant_count")
  participantsInfo      Json               @default("[]") @map("participants_info")
  customResponses       Json               @default("{}") @map("custom_responses")
  confirmationToken     String?            @unique @map("confirmation_token")
  amountPaid            Decimal?           @db.Decimal(10, 2) @map("amount_paid")
  stripePaymentIntentId String?            @map("stripe_payment_intent_id")
  registeredAt          DateTime           @default(now()) @map("registered_at")
  checkedInAt           DateTime?          @map("checked_in_at")
  canceledAt            DateTime?          @map("canceled_at")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([eventId, status])
  @@index([userId])
  @@map("event_registrations")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String?
  data      Json     @default("{}")
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  actionUrl String?  @map("action_url")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_sessions")
}
