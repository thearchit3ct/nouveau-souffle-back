// Nouveau Souffle - Prisma Schema
// Stack: PostgreSQL 16, Prisma 7, NestJS 11
// Auth: SuperTokens (passkey + email/pwd + 2FA TOTP)

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
  DELETED
}

enum Civility {
  M
  MME
  AUTRE
}

enum DonationType {
  ONE_TIME
  RECURRING
}

enum DonationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELED
}

enum PaymentMethod {
  CARD
  SEPA
  APPLE_PAY
  GOOGLE_PAY
}

enum ReceiptStatus {
  GENERATED
  SENT
  DOWNLOADED
  CANCELED
}

enum RecurrenceFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum RecurrenceStatus {
  ACTIVE
  PAUSED
  CANCELED
  EXPIRED
}

enum MembershipStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELED
  REJECTED
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EventType {
  CONFERENCE
  FORMATION
  COLLECTE
  AG
  SOCIAL
  WORKSHOP
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ONGOING
  COMPLETED
  CANCELED
}

enum EventVisibility {
  PUBLIC
  MEMBERS
  PRIVATE
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELED
  WAITLISTED
}

enum UserRole {
  ANONYMOUS
  DONOR
  MEMBER
  VOLUNTEER
  COORDINATOR
  ADMIN
  SUPER_ADMIN
}

enum VolunteerStatus {
  PENDING
  APPROVED
  REJECTED
  PAUSED
}

enum DocumentVisibility {
  PUBLIC
  MEMBERS
  ADMIN
}

enum DocumentCategory {
  GUIDE
  REPORT
  FORM
  MEETING_MINUTES
  STATUTES
  TRAINING
  OTHER
}

enum TrainingStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TrainingModuleType {
  VIDEO
  PDF
  QUIZ
  TEXT
}

enum EnrollmentStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

// Module Maraude enums

enum MaraudeStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum EncounterType {
  FIRST_CONTACT
  FOLLOW_UP
  EMERGENCY
  CHECK_IN
  REFERRAL_ONLY
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReferralStatus {
  PROPOSED
  ACCEPTED
  COMPLETED
  REFUSED
  NO_SHOW
  EXPIRED
}

enum BeneficiaryGender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum HousingStatus {
  STREET
  SHELTER
  SQUAT
  TEMPORARY
  HOSTED
  HOUSED
  UNKNOWN
}

enum AdministrativeStatus {
  REGULAR
  ASYLUM_SEEKER
  REFUGEE
  UNDOCUMENTED
  UNKNOWN
  OTHER
}

enum GdprConsentStatus {
  GIVEN
  ORAL
  VITAL
  REFUSED
  NOT_ASKED
  WITHDRAWN
}

enum MaraudeIncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ---------------------------------------------------------------------------
// Models
// ---------------------------------------------------------------------------

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  supertokensId     String?   @unique @map("supertokens_id")
  firstName         String    @map("first_name")
  lastName          String    @map("last_name")
  phone             String?
  civility          Civility?
  birthDate         DateTime? @map("birth_date")
  avatarUrl         String?   @map("avatar_url")
  emailVerified     Boolean   @default(false) @map("email_verified")
  isActive          Boolean   @default(true) @map("is_active")
  status            UserStatus @default(PENDING)
  role              UserRole   @default(DONOR)
  preferences       Json      @default("{}")
  addressLine1      String?   @map("address_line_1")
  addressLine2      String?   @map("address_line_2")
  postalCode        String?   @map("postal_code")
  city              String?
  country           String    @default("FR")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  donations          Donation[]
  memberships        Membership[]        @relation("MembershipUser")
  secondaryMemberships Membership[]      @relation("MembershipSecondaryUser")
  approvedMemberships  Membership[]      @relation("MembershipApprover")
  articles           Article[]
  eventsCreated      Event[]
  eventRegistrations EventRegistration[]
  notifications      Notification[]
  auditLogs          AuditLog[]
  sessions           UserSession[]
  donationRecurrences DonationRecurrence[]
  volunteers         Volunteer[]
  approvedVolunteers Volunteer[]         @relation("VolunteerApprover")
  documents          Document[]
  trainingEnrollments TrainingEnrollment[]

  // Module Maraude
  coordinatedMaraudes      Maraude[]            @relation("MaraudeCoordinator")
  maraudeParticipations    MaraudeParticipant[] @relation("MaraudeParticipants")
  encountersRecorded       Encounter[]          @relation("EncounterRecordedBy")
  referralsMade            Referral[]           @relation("ReferralBy")
  maraudeReportsAuthored   MaraudeReport[]      @relation("MaraudeReportAuthor")
  maraudeIncidentsReported MaraudeIncident[]    @relation("IncidentReporter")

  @@index([status])
  @@index([role])
  @@index([email])
  @@map("users")
}

model Organization {
  id           String   @id @default(uuid())
  name         String
  siren        String?
  type         String   @default("company")
  addressLine1 String?  @map("address_line_1")
  addressLine2 String?  @map("address_line_2")
  postalCode   String?  @map("postal_code")
  city         String?
  country      String   @default("FR")
  phone        String?
  email        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  donations Donation[]

  @@map("organizations")
}

model MembershipType {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  description    String?
  price          Decimal  @db.Decimal(10, 2)
  durationMonths Int      @default(12) @map("duration_months")
  maxUsers       Int      @default(1) @map("max_users")
  benefits       Json     @default("[]")
  isActive       Boolean  @default(true) @map("is_active")
  displayOrder   Int      @default(0) @map("display_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  memberships Membership[]

  @@map("membership_types")
}

model Membership {
  id                  String           @id @default(uuid())
  userId              String           @map("user_id")
  membershipTypeId    String           @map("membership_type_id")
  secondaryUserId     String?          @map("secondary_user_id")
  status              MembershipStatus @default(PENDING)
  amountPaid          Decimal          @db.Decimal(10, 2) @map("amount_paid")
  stripeSubscriptionId String?         @map("stripe_subscription_id")
  startDate           DateTime         @map("start_date")
  endDate             DateTime         @map("end_date")
  memberNumber        String?          @unique @map("member_number")
  autoRenew           Boolean          @default(false) @map("auto_renew")
  approvedAt          DateTime?        @map("approved_at")
  approvedById        String?          @map("approved_by_id")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  user           User           @relation("MembershipUser", fields: [userId], references: [id], onDelete: Cascade)
  membershipType MembershipType @relation(fields: [membershipTypeId], references: [id], onDelete: Restrict)
  secondaryUser  User?          @relation("MembershipSecondaryUser", fields: [secondaryUserId], references: [id], onDelete: SetNull)
  approvedBy     User?          @relation("MembershipApprover", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([membershipTypeId])
  @@map("memberships")
}

model Donation {
  id                    String          @id @default(uuid())
  userId                String?         @map("user_id")
  organizationId        String?         @map("organization_id")
  projectId             String?         @map("project_id")
  recurrenceId          String?         @map("recurrence_id")
  amount                Decimal         @db.Decimal(12, 2)
  currency              String          @default("EUR")
  type                  DonationType
  status                DonationStatus  @default(PENDING)
  paymentMethod         PaymentMethod?  @map("payment_method")
  stripePaymentIntentId String?         @map("stripe_payment_intent_id")
  stripeChargeId        String?         @map("stripe_charge_id")
  isAnonymous           Boolean         @default(false) @map("is_anonymous")
  receiptRequested      Boolean         @default(true) @map("receipt_requested")
  receiptNumber         String?         @map("receipt_number")
  metadata              Json            @default("{}")
  paidAt                DateTime?       @map("paid_at")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")

  user         User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization?       @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  project      Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  recurrence   DonationRecurrence? @relation(fields: [recurrenceId], references: [id], onDelete: SetNull)
  receipts     DonationReceipt[]

  @@index([userId, status, paidAt])
  @@index([projectId])
  @@index([organizationId])
  @@map("donations")
}

model DonationReceipt {
  id            String        @id @default(uuid())
  donationId    String        @map("donation_id")
  receiptNumber String        @unique @map("receipt_number")
  fiscalYear    Int           @map("fiscal_year")
  amount        Decimal       @db.Decimal(12, 2)
  filePath      String        @map("file_path")
  status        ReceiptStatus @default(GENERATED)
  generatedAt   DateTime      @default(now()) @map("generated_at")
  sentAt        DateTime?     @map("sent_at")
  createdAt     DateTime      @default(now()) @map("created_at")

  donation Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)

  @@index([donationId])
  @@index([fiscalYear])
  @@map("donation_receipts")
}

model DonationRecurrence {
  id                  String              @id @default(uuid())
  userId              String              @map("user_id")
  projectId           String?             @map("project_id")
  amount              Decimal             @db.Decimal(12, 2)
  frequency           RecurrenceFrequency @default(MONTHLY)
  status              RecurrenceStatus    @default(ACTIVE)
  stripeSubscriptionId String?            @map("stripe_subscription_id")
  stripeCustomerId    String?             @map("stripe_customer_id")
  nextPaymentDate     DateTime?           @map("next_payment_date")
  lastPaymentDate     DateTime?           @map("last_payment_date")
  paymentCount        Int                 @default(0) @map("payment_count")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  canceledAt          DateTime?           @map("canceled_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  donations Donation[]

  @@index([userId, status])
  @@index([status, nextPaymentDate])
  @@map("donation_recurrences")
}

model Project {
  id              String        @id @default(uuid())
  name            String
  slug            String        @unique
  description     String?
  targetAmount    Decimal?      @db.Decimal(12, 2) @map("target_amount")
  collectedAmount Decimal       @default(0) @db.Decimal(12, 2) @map("collected_amount")
  status          ProjectStatus @default(DRAFT)
  startDate       DateTime?     @map("start_date")
  endDate         DateTime?     @map("end_date")
  imageUrl        String?       @map("image_url")
  isFeatured      Boolean       @default(false) @map("is_featured")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  donations            Donation[]
  recurrences          DonationRecurrence[]
  volunteerAssignments VolunteerAssignment[]

  @@index([status])
  @@index([slug])
  @@map("projects")
}

model Article {
  id               String        @id @default(uuid())
  authorId         String        @map("author_id")
  title            String
  slug             String        @unique
  excerpt          String?
  content          String
  featuredImageUrl String?       @map("featured_image_url")
  status           ArticleStatus @default(DRAFT)
  seoMetadata      Json          @default("{}") @map("seo_metadata")
  viewCount        Int           @default(0) @map("view_count")
  commentsEnabled  Boolean       @default(false) @map("comments_enabled")
  publishedAt      DateTime?     @map("published_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  author     User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories ArticleCategory[]

  @@index([authorId])
  @@index([status, publishedAt])
  @@index([slug])
  @@map("articles")
}

model Category {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  description  String?
  color        String?
  parentId     String?  @map("parent_id")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  parent   Category?         @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[]        @relation("CategoryHierarchy")
  articles ArticleCategory[]

  @@index([slug])
  @@map("categories")
}

model ArticleCategory {
  id         String   @id @default(uuid())
  articleId  String   @map("article_id")
  categoryId String   @map("category_id")
  createdAt  DateTime @default(now()) @map("created_at")

  article  Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([articleId, categoryId])
  @@map("article_categories")
}

model Event {
  id                 String          @id @default(uuid())
  createdById        String          @map("created_by_id")
  title              String
  slug               String          @unique
  description        String?
  type               EventType       @default(OTHER)
  status             EventStatus     @default(DRAFT)
  visibility         EventVisibility @default(PUBLIC)
  startDatetime      DateTime        @map("start_datetime")
  endDatetime        DateTime?       @map("end_datetime")
  locationName       String?         @map("location_name")
  locationAddress    String?         @map("location_address")
  latitude           Decimal?        @db.Decimal(10, 7)
  longitude          Decimal?        @db.Decimal(10, 7)
  capacity           Int?
  registrationsCount Int             @default(0) @map("registrations_count")
  price              Decimal         @default(0) @db.Decimal(10, 2)
  isFree             Boolean         @default(true) @map("is_free")
  imageUrl           String?         @map("image_url")
  program            String?
  customFields       Json            @default("[]") @map("custom_fields")
  publishedAt        DateTime?       @map("published_at")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  createdBy            User                @relation(fields: [createdById], references: [id], onDelete: Cascade)
  registrations        EventRegistration[]
  volunteerAssignments VolunteerAssignment[]

  @@index([status, startDatetime])
  @@index([slug])
  @@map("events")
}

model EventRegistration {
  id                    String             @id @default(uuid())
  eventId               String             @map("event_id")
  userId                String?            @map("user_id")
  status                RegistrationStatus @default(CONFIRMED)
  participantCount      Int                @default(1) @map("participant_count")
  participantsInfo      Json               @default("[]") @map("participants_info")
  customResponses       Json               @default("{}") @map("custom_responses")
  confirmationToken     String?            @unique @map("confirmation_token")
  amountPaid            Decimal?           @db.Decimal(10, 2) @map("amount_paid")
  stripePaymentIntentId String?            @map("stripe_payment_intent_id")
  registeredAt          DateTime           @default(now()) @map("registered_at")
  checkedInAt           DateTime?          @map("checked_in_at")
  canceledAt            DateTime?          @map("canceled_at")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([eventId, status])
  @@index([userId])
  @@map("event_registrations")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String?
  data      Json     @default("{}")
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  actionUrl String?  @map("action_url")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_sessions")
}

model Volunteer {
  id              String          @id @default(uuid())
  userId          String?         @map("user_id")
  email           String
  firstName       String          @map("first_name")
  lastName        String          @map("last_name")
  phone           String?
  skills          String[]        @default([])
  availabilities  Json            @default("{}")
  motivation      String?
  status          VolunteerStatus @default(PENDING)
  coordinatorNotes String?        @map("coordinator_notes")
  approvedAt      DateTime?       @map("approved_at")
  approvedById    String?         @map("approved_by_id")
  rejectedAt      DateTime?       @map("rejected_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  user        User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  approvedBy  User?                 @relation("VolunteerApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  assignments VolunteerAssignment[]
  enrollments TrainingEnrollment[]
  maraudeParticipations MaraudeParticipant[]

  @@index([status])
  @@index([email])
  @@map("volunteers")
}

model VolunteerAssignment {
  id           String    @id @default(uuid())
  volunteerId  String    @map("volunteer_id")
  eventId      String?   @map("event_id")
  projectId    String?   @map("project_id")
  role         String?
  notes        String?
  status       String    @default("ASSIGNED")
  assignedAt   DateTime  @default(now()) @map("assigned_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  volunteer Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  event     Event?    @relation(fields: [eventId], references: [id], onDelete: SetNull)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([volunteerId])
  @@index([eventId])
  @@map("volunteer_assignments")
}

model Document {
  id           String             @id @default(uuid())
  uploadedById String             @map("uploaded_by_id")
  title        String
  description  String?
  fileName     String             @map("file_name")
  fileSize     Int                @map("file_size")
  mimeType     String             @map("mime_type")
  filePath     String             @map("file_path")
  visibility   DocumentVisibility @default(MEMBERS)
  category     DocumentCategory   @default(OTHER)
  tags         String[]           @default([])
  downloadCount Int               @default(0) @map("download_count")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  uploadedBy User @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([visibility])
  @@index([category])
  @@map("documents")
}

model Training {
  id          String         @id @default(uuid())
  title       String
  slug        String         @unique
  description String?
  imageUrl    String?        @map("image_url")
  status      TrainingStatus @default(DRAFT)
  duration    Int?
  difficulty  String         @default("beginner")
  tags        String[]       @default([])
  publishedAt DateTime?      @map("published_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  modules     TrainingModule[]
  enrollments TrainingEnrollment[]

  @@index([status])
  @@index([slug])
  @@map("trainings")
}

model TrainingModule {
  id          String             @id @default(uuid())
  trainingId  String             @map("training_id")
  title       String
  type        TrainingModuleType @default(TEXT)
  content     String?
  fileUrl     String?            @map("file_url")
  duration    Int?
  sortOrder   Int                @default(0) @map("sort_order")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  training    Training              @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  completions TrainingCompletion[]

  @@index([trainingId, sortOrder])
  @@map("training_modules")
}

model TrainingEnrollment {
  id           String           @id @default(uuid())
  trainingId   String           @map("training_id")
  userId       String?          @map("user_id")
  volunteerId  String?          @map("volunteer_id")
  status       EnrollmentStatus @default(IN_PROGRESS)
  progress     Int              @default(0)
  startedAt    DateTime         @default(now()) @map("started_at")
  completedAt  DateTime?        @map("completed_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  training    Training              @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user        User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  volunteer   Volunteer?            @relation(fields: [volunteerId], references: [id], onDelete: SetNull)
  completions TrainingCompletion[]

  @@unique([trainingId, userId])
  @@index([userId])
  @@index([volunteerId])
  @@map("training_enrollments")
}

model TrainingCompletion {
  id           String   @id @default(uuid())
  enrollmentId String   @map("enrollment_id")
  moduleId     String   @map("module_id")
  completedAt  DateTime @default(now()) @map("completed_at")

  enrollment TrainingEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  module     TrainingModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, moduleId])
  @@map("training_completions")
}

model StripeWebhookLog {
  id          String   @id @default(uuid())
  eventId     String   @unique @map("event_id")
  type        String
  data        Json     @default("{}")
  processedAt DateTime @default(now()) @map("processed_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([type])
  @@map("stripe_webhook_logs")
}

// ---------------------------------------------------------------------------
// Module Maraude
// ---------------------------------------------------------------------------

model Beneficiary {
  id                    String               @id @default(uuid())
  nickname              String
  firstName             String?              @map("first_name")
  lastName              String?              @map("last_name")
  estimatedAge          Int?                 @map("estimated_age")
  dateOfBirth           DateTime?            @map("date_of_birth")
  gender                BeneficiaryGender    @default(UNKNOWN)
  nationality           String?
  spokenLanguages       String[]             @default([]) @map("spoken_languages")

  housingStatus         HousingStatus        @default(UNKNOWN) @map("housing_status")
  administrativeStatus  AdministrativeStatus @default(UNKNOWN) @map("administrative_status")
  hasEmployment         Boolean?             @map("has_employment")
  healthNotes           String?              @map("health_notes")
  hasPets               Boolean              @default(false) @map("has_pets")
  petDetails            String?              @map("pet_details")
  usualLocation         String?              @map("usual_location")
  usualLocationLat      Decimal?             @db.Decimal(10, 7) @map("usual_location_lat")
  usualLocationLng      Decimal?             @db.Decimal(10, 7) @map("usual_location_lng")

  photoUrl              String?              @map("photo_url")
  photoConsentGiven     Boolean              @default(false) @map("photo_consent_given")
  photoConsentDate      DateTime?            @map("photo_consent_date")

  gdprConsentStatus     GdprConsentStatus    @default(NOT_ASKED) @map("gdpr_consent_status")
  gdprConsentDate       DateTime?            @map("gdpr_consent_date")
  dataRetentionUntil    DateTime?            @map("data_retention_until")
  anonymizedAt          DateTime?            @map("anonymized_at")

  notes                 String?
  tags                  String[]             @default([])

  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  deletedAt             DateTime?            @map("deleted_at")

  encounters            Encounter[]
  referrals             Referral[]

  @@index([nickname])
  @@index([gdprConsentStatus])
  @@index([housingStatus])
  @@index([deletedAt])
  @@map("beneficiaries")
}

model MaraudeZone {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String?
  color        String?
  centerLat    Decimal? @db.Decimal(10, 7) @map("center_lat")
  centerLng    Decimal? @db.Decimal(10, 7) @map("center_lng")
  radiusKm     Decimal? @db.Decimal(5, 2) @map("radius_km")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  maraudes     Maraude[]

  @@map("maraude_zones")
}

model Maraude {
  id                  String         @id @default(uuid())
  zoneId              String?        @map("zone_id")
  coordinatorId       String         @map("coordinator_id")
  title               String?
  description         String?
  status              MaraudeStatus  @default(PLANNED)

  plannedStartAt      DateTime       @map("planned_start_at")
  plannedEndAt        DateTime?      @map("planned_end_at")
  actualStartAt       DateTime?      @map("actual_start_at")
  actualEndAt         DateTime?      @map("actual_end_at")

  startLocationName   String?        @map("start_location_name")
  startLocationLat    Decimal?       @db.Decimal(10, 7) @map("start_location_lat")
  startLocationLng    Decimal?       @db.Decimal(10, 7) @map("start_location_lng")

  weatherConditions   String?        @map("weather_conditions")
  temperatureCelsius  Decimal?       @db.Decimal(4, 1) @map("temperature_celsius")
  generalObservations String?        @map("general_observations")
  vehicleInfo         String?        @map("vehicle_info")
  suppliesDistributed Json           @default("{}") @map("supplies_distributed")

  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  zone                MaraudeZone?   @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  coordinator         User           @relation("MaraudeCoordinator", fields: [coordinatorId], references: [id], onDelete: Restrict)
  participants        MaraudeParticipant[]
  encounters          Encounter[]
  report              MaraudeReport?
  incidents           MaraudeIncident[]

  @@index([status, plannedStartAt])
  @@index([zoneId])
  @@index([coordinatorId])
  @@map("maraudes")
}

model MaraudeParticipant {
  id           String    @id @default(uuid())
  maraudeId    String    @map("maraude_id")
  userId       String?   @map("user_id")
  volunteerId  String?   @map("volunteer_id")
  role         String    @default("VOLUNTEER")
  joinedAt     DateTime  @default(now()) @map("joined_at")
  leftAt       DateTime? @map("left_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  maraude      Maraude    @relation(fields: [maraudeId], references: [id], onDelete: Cascade)
  user         User?      @relation("MaraudeParticipants", fields: [userId], references: [id], onDelete: SetNull)
  volunteer    Volunteer? @relation(fields: [volunteerId], references: [id], onDelete: SetNull)

  @@unique([maraudeId, userId])
  @@index([maraudeId])
  @@map("maraude_participants")
}

model NeedCategory {
  id           String   @id @default(uuid())
  code         String   @unique
  name         String
  description  String?
  icon         String?
  color        String?
  parentId     String?  @map("parent_id")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  parent         NeedCategory?     @relation("NeedHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children       NeedCategory[]    @relation("NeedHierarchy")
  encounterNeeds EncounterNeed[]

  @@index([parentId])
  @@map("need_categories")
}

model ActionCategory {
  id           String   @id @default(uuid())
  code         String   @unique
  name         String
  description  String?
  icon         String?
  color        String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  encounterActions EncounterAction[]

  @@map("action_categories")
}

model Encounter {
  id               String        @id @default(uuid())
  maraudeId        String        @map("maraude_id")
  beneficiaryId    String?       @map("beneficiary_id")
  recordedById     String        @map("recorded_by_id")

  type             EncounterType @default(FIRST_CONTACT)
  urgencyLevel     UrgencyLevel  @default(LOW) @map("urgency_level")

  locationName     String?       @map("location_name")
  locationLat      Decimal?      @db.Decimal(10, 7) @map("location_lat")
  locationLng      Decimal?      @db.Decimal(10, 7) @map("location_lng")

  physicalState    String?       @map("physical_state")
  mentalState      String?       @map("mental_state")
  socialContext     String?       @map("social_context")
  notes            String?
  privateNotes     String?       @map("private_notes")

  itemsDistributed Json          @default("{}") @map("items_distributed")
  durationMinutes  Int?          @map("duration_minutes")

  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  maraude          Maraude       @relation(fields: [maraudeId], references: [id], onDelete: Cascade)
  beneficiary      Beneficiary?  @relation(fields: [beneficiaryId], references: [id], onDelete: SetNull)
  recordedBy       User          @relation("EncounterRecordedBy", fields: [recordedById], references: [id], onDelete: Restrict)
  needs            EncounterNeed[]
  actions          EncounterAction[]
  referrals        Referral[]

  @@index([maraudeId])
  @@index([beneficiaryId])
  @@index([urgencyLevel])
  @@index([createdAt])
  @@map("encounters")
}

model EncounterNeed {
  id             String   @id @default(uuid())
  encounterId    String   @map("encounter_id")
  needCategoryId String   @map("need_category_id")
  priority       Int      @default(0)
  isAddressed    Boolean  @default(false) @map("is_addressed")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")

  encounter    Encounter    @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  needCategory NeedCategory @relation(fields: [needCategoryId], references: [id], onDelete: Restrict)

  @@unique([encounterId, needCategoryId])
  @@map("encounter_needs")
}

model EncounterAction {
  id               String   @id @default(uuid())
  encounterId      String   @map("encounter_id")
  actionCategoryId String   @map("action_category_id")
  quantity         Int      @default(1)
  notes            String?
  createdAt        DateTime @default(now()) @map("created_at")

  encounter      Encounter      @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  actionCategory ActionCategory @relation(fields: [actionCategoryId], references: [id], onDelete: Restrict)

  @@unique([encounterId, actionCategoryId])
  @@map("encounter_actions")
}

model ReferralStructure {
  id                String   @id @default(uuid())
  name              String
  type              String
  address           String?
  phone             String?
  email             String?
  website           String?
  openingHours      String?  @map("opening_hours")
  capacity          Int?
  admissionCriteria String?  @map("admission_criteria")
  latitude          Decimal? @db.Decimal(10, 7)
  longitude         Decimal? @db.Decimal(10, 7)
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  referrals         Referral[]

  @@index([type])
  @@index([isActive])
  @@map("referral_structures")
}

model Referral {
  id               String         @id @default(uuid())
  encounterId      String?        @map("encounter_id")
  beneficiaryId    String         @map("beneficiary_id")
  structureId      String?        @map("structure_id")
  referredById     String         @map("referred_by_id")

  structureName    String?        @map("structure_name")
  reason           String?
  status           ReferralStatus @default(PROPOSED)
  notes            String?
  appointmentDate  DateTime?      @map("appointment_date")
  completedAt      DateTime?      @map("completed_at")
  followUpDate     DateTime?      @map("follow_up_date")
  followUpNotes    String?        @map("follow_up_notes")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  encounter        Encounter?         @relation(fields: [encounterId], references: [id], onDelete: SetNull)
  beneficiary      Beneficiary        @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  structure        ReferralStructure? @relation(fields: [structureId], references: [id], onDelete: SetNull)
  referredBy       User               @relation("ReferralBy", fields: [referredById], references: [id], onDelete: Restrict)

  @@index([beneficiaryId])
  @@index([status])
  @@index([followUpDate])
  @@map("referrals")
}

model MaraudeReport {
  id                     String    @id @default(uuid())
  maraudeId              String    @unique @map("maraude_id")
  authorId               String    @map("author_id")

  totalEncounters        Int       @default(0) @map("total_encounters")
  newBeneficiaries       Int       @default(0) @map("new_beneficiaries")
  followUpEncounters     Int       @default(0) @map("follow_up_encounters")
  emergencyEncounters    Int       @default(0) @map("emergency_encounters")
  referralsMade          Int       @default(0) @map("referrals_made")

  mealsDistributed       Int       @default(0) @map("meals_distributed")
  blanketsDistributed    Int       @default(0) @map("blankets_distributed")
  hygieneKitsDistributed Int       @default(0) @map("hygiene_kits_distributed")
  otherDistributions     Json      @default("{}") @map("other_distributions")

  summary                String?
  pointsOfAttention      String?   @map("points_of_attention")
  positiveHighlights     String?   @map("positive_highlights")
  suggestions            String?

  submittedAt            DateTime? @map("submitted_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  maraude                Maraude   @relation(fields: [maraudeId], references: [id], onDelete: Cascade)
  author                 User      @relation("MaraudeReportAuthor", fields: [authorId], references: [id], onDelete: Restrict)

  @@map("maraude_reports")
}

model MaraudeIncident {
  id            String                   @id @default(uuid())
  maraudeId     String                   @map("maraude_id")
  reportedById  String                   @map("reported_by_id")
  severity      MaraudeIncidentSeverity  @default(LOW)
  title         String
  description   String?
  locationName  String?                  @map("location_name")
  locationLat   Decimal?                 @db.Decimal(10, 7) @map("location_lat")
  locationLng   Decimal?                 @db.Decimal(10, 7) @map("location_lng")
  occurredAt    DateTime                 @map("occurred_at")
  resolvedAt    DateTime?                @map("resolved_at")
  resolution    String?
  createdAt     DateTime                 @default(now()) @map("created_at")
  updatedAt     DateTime                 @updatedAt @map("updated_at")

  maraude       Maraude @relation(fields: [maraudeId], references: [id], onDelete: Cascade)
  reportedBy    User    @relation("IncidentReporter", fields: [reportedById], references: [id], onDelete: Restrict)

  @@index([maraudeId])
  @@index([severity])
  @@map("maraude_incidents")
}
